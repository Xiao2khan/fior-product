<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/website/main}">
<head>
    <link rel="stylesheet" th:href="@{/css/website/home-page.css}">
</head>
<body>
<div layout:fragment="website-content">
    <section class="hero-section">
        <!-- Ph·∫ßn ch·ª©a c√°c banner -->
        <div class="hero-track">

            <!-- Banner 1 -->
            <div class="hero-wrapper position-relative">
                <div class="hero-image">
                    <img th:src="@{/image/image_154.png}" alt="C√† Chua Ph∆°i N·∫Øng">
                </div>
                <div class="hero-content position-absolute d-flex flex-column">
                    <h1 class="hero-title" th:text="#{home.title}"></h1>
                    <p class="hero-description" th:utext="#{home.description}"></p>
                    <a href="javascript:void(0)" class="read-more-btn toggle-desc">Read more</a>
                    <div class="hero-button-wrapper d-flex">
                        <a href="#" class="hero-button" th:text="#{home.button}">T√¨m hi·ªÉu th√™m</a>
                    </div>
                </div>
            </div>

            <!-- Banner 2 -->
            <div class="hero-wrapper position-relative">
                <div class="hero-image">
                    <img th:src="@{/image/311ac65e92c70f8914e6d739a0bc9a972aa3da32.jpg}">
                </div>
                <div class="hero-content position-absolute d-flex flex-column">
                    <h1 class="hero-title" th:text="#{home.title_2}"></h1>
                    <p class="hero-description" th:utext="#{home.description_2}"></p>
                    <a href="javascript:void(0)" class="read-more-btn toggle-desc">Read more</a>
                    <div class="hero-button-wrapper d-flex">
                        <a href="#" class="hero-button" th:text="#{home.button}">T√¨m hi·ªÉu th√™m</a>
                    </div>
                </div>
            </div>

            <!-- Banner 3 -->
            <div class="hero-wrapper position-relative">
                <div class="hero-image">
                    <img th:src="@{/image/banner_3.jpg}">
                </div>
                <div class="hero-content position-absolute d-flex flex-column">
                    <h1 class="hero-title" th:utext="#{home.title_3}"></h1>
                    <p class="hero-description" th:utext="#{home.description_3}"></p>
                    <a href="javascript:void(0)" class="read-more-btn toggle-desc">Read more</a>
                    <div class="hero-button-wrapper d-flex">
                        <a href="#" class="hero-button" th:text="#{home.button}">T√¨m hi·ªÉu th√™m</a>
                    </div>
                </div>
            </div>

        </div> <!-- K·∫øt th√∫c .hero-track -->

        <!-- C√°c ch·∫•m tr√≤n ƒëi·ªÅu h∆∞·ªõng -->
        <div class="hero-indicators d-flex justify-content-center">
            <span class="dot active"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
    </section>

    <section class="product-section">
        <div class="product-container container d-flex flex-column" style="gap:32px">
            <div class="product-title position-relative" th:attr="data-lang=${lang}">
                <div class="text-title text-center fw-bold" th:text="#{productTitle.title}"></div>
                <div  th:if="${products != null and !#lists.isEmpty(products)}">>
                    <div id="prev-btn" class="icon position-absolute start-0 d-flex align-items-center justify-content-center" style="cursor:pointer;">
                        <i class="fa-solid fa-arrow-left"></i>
                    </div>

                    <div id="next-btn" class="icon position-absolute end-0 d-flex align-items-center justify-content-center" style="cursor:pointer;">
                        <i class="fa-solid fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <!-- Product list t·ª´ nh√°nh m·ªõi (Stashed changes) -->
            <div class="product-content-row row align-items-center justify-content-center" id="product-list"
                 th:data-products="${products}">
            </div>

            <nav aria-label="Page navigation" class="mt-4"
                 th:if="${products != null and !#lists.isEmpty(products)}">
                <ul class="pagination justify-content-center" id="pagination" style="gap: 8px;"></ul>
            </nav>

        </div>
    </section>
    <section class="production-process-section">
        <div class="production-process-container container">
            <div class="production-process-content d-flex flex-column align-items-center">
                <div class="production-process-title d-flex flex-column align-items-center text-center fw-bolder">
                    <div th:utext="#{productionProcess.title}"></div>
                    <div class="line"></div>
                </div>
                <div class="production-process-detail position-relative d-flex align-items-center w-100">
                    <div class="image-content w-100">
                        <img th:src="@{/image/6f4d1574c1b8da33ab0c9054f07e42fafd367a56.png}" alt="">
                    </div>
                    <div class="section-text position-absolute">
                        <div class="text-content d-flex align-items-center">
                            <div class="title-number fw-bolder">01</div>
                            <div class="detail-content d-flex flex-column">
                                <div class="fw-bolder" th:text="#{sectionText1.h}"></div>
                                <div class="fw-normal" th:utext="#{sectionText1.description}"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="production-process-detail position-relative d-flex align-items-center w-100">
                    <div class="image-content w-100">
                        <img th:src="@{/image/3a2cdd2d7576198b2e7617c83f84a97ae6ccac9a.png}" alt=""></div>
                    <div class="section-text position-absolute">
                        <div class="text-content d-flex align-items-center">
                            <div class="title-number fw-bolder">02</div>
                            <div class="detail-content d-flex flex-column">
                                <div class="fw-bolder" th:text="#{sectionText2.h}"></div>
                                <div class="fw-normal" th:text="#{sectionText2.description}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="production-process-detail position-relative d-flex align-items-center w-100">
                    <div class="image-content w-100">
                        <img th:src="@{/image/1ee44764fd19e3eddfa06d167a7bab0fd10f969f.png}" alt="">
                    </div>
                    <div class="section-text position-absolute">
                        <div class="text-content d-flex align-items-center">
                            <div class="title-number fw-bolder">03</div>
                            <div class="detail-content d-flex flex-column">
                                <div class="fw-bolder"th:utext = "#{sectionText3.h}"></div>
                                <div class="fw-normal" th:utext = "#{sectionText3.description}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="production-process-detail position-relative d-flex align-items-center w-100">
                    <div class="image-content w-100">
                        <img th:src="@{/image/f87d90ad85799eac87e2798c1d3a696b1b023da2.png}" alt="">
                    </div>
                    <div class="section-text position-absolute">
                        <div class="text-content d-flex align-items-center">
                            <div class="title-number fw-bolder">04</div>
                            <div class="detail-content d-flex flex-column">
                                <div class="fw-bolder" th:text="#{sectionText4.h}"></div>
                                <div class="fw-normal" th:text="#{sectionText4.description}"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="production-process-detail position-relative d-flex align-items-center w-100">
                    <div class="image-content w-100">
                        <img th:src="@{/image/ff38eb69534a8911fe63bfe9e2f0b2c695632f5e.png}" alt="">
                    </div>
                    <div class="section-text position-absolute">
                        <div class="text-content d-flex align-items-center">
                            <div class="title-number fw-bolder">05</div>
                            <div class="detail-content d-flex flex-column">
                                <div class="fw-bolder" th:text="#{sectionText5.h}"></div>
                                <div class="fw-normal" th:utext="#{sectionText5.description}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="production-process-detail position-relative d-flex align-items-center w-100">
                    <div class="image-content w-100">
                        <img th:src="@{/image/9b2744d87da0b3e1afce7464bbc252624fcde9c4.png}" alt="">
                    </div>
                    <div class="section-text position-absolute">
                        <div class="text-content d-flex align-items-center">
                            <div class="title-number fw-bolder">06</div>
                            <div class="detail-content d-flex flex-column">
                                <div class="fw-bolder" th:utext="#{sectionText6.h}">
                                </div>
                                <div class="fw-normal" th:utext="#{sectionText6.description}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="our-products-section" style="margin-top: 100px">
        <div class="our-product-container container">
            <div class="text-center fw-bold" th:text="#{ourProductContainer.title}"
                 style="margin-bottom: 48px;font-weight: 600;font-size: 32px;line-height: 48px;">
            </div>
            <div class="d-flex justify-content-center flex-wrap" style="gap: 28px">
                <div class="d-flex flex-column" style="gap: 28px; width: 180px">
                    <div class="d-flex flex-column align-items-center" style="gap: 16px">
                        <div style="width: 100px">
                            <img th:src="@{/image/image_164.png}" alt="">
                        </div>
                        <div class="text-center fw-bold" style="font-size: 20px;line-height: 24px;" th:text="#{ourProduct1.title}">

                        </div>
                    </div>
                    <div class="text-center" style="font-weight: 400;font-size: 14px;line-height: 24px;" th:utext="#{ourProduct1.desc}">

                    </div>
                </div>
                <div class="straight-line d-none d-sm-block"
                     style="border-left: 1.5px solid rgba(44, 110, 31, 1)"></div>
                <div class="d-flex flex-column" style="gap: 28px; width: 180px">
                    <div class="d-flex flex-column align-items-center" style="gap: 16px">
                        <div style="width: 100px">
                            <img th:src="@{/image/image_165.png}" alt="">
                        </div>
                        <div class="text-center fw-bold" style="font-size: 20px;line-height: 24px;" th:text="#{ourProduct2.title}">

                        </div>
                    </div>
                    <div class="text-center" style="font-weight: 400;font-size: 14px;line-height: 24px;" th:utext="#{ourProduct2.desc}">

                    </div>
                </div>
                <div class="straight-line d-none d-md-block"
                     style="border-left: 1.5px solid rgba(44, 110, 31, 1)"></div>
                <div class="d-flex flex-column" style="gap: 28px; width: 180px">
                    <div class="d-flex flex-column align-items-center" style="gap: 16px">
                        <div style="width: 100px">
                            <img th:src="@{/image/image_166.png}" alt="">
                        </div>
                        <div class="text-center fw-bold" style="font-size: 20px;line-height: 24px;" th:text="#{ourProduct3.title}">

                        </div>
                    </div>
                    <div class="text-center" style="font-weight: 400;font-size: 14px;line-height: 24px;" th:utext="#{ourProduct3.desc}">

                    </div>
                </div>
                <div class="straight-line d-none d-sm-block d-md-none d-lg-block"
                     style="border-left: 1.5px solid rgba(44, 110, 31, 1)"></div>
                <div class="d-flex flex-column" style="gap: 28px; width: 180px">
                    <div class="d-flex flex-column align-items-center" style="gap: 16px">
                        <div style="width: 100px">
                            <img th:src="@{/image/image_167.png}" alt="">
                        </div>
                        <div class="text-center fw-bold" style="font-size: 20px;line-height: 24px;" th:text="#{ourProduct4.title}">

                        </div>
                    </div>
                    <div class="text-center" style="font-weight: 400;font-size: 14px;line-height: 24px;" th:utext="#{ourProduct4.desc}">

                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        var products = /*[[${productsJson}]]*/ "[]";

        if (typeof products === "string") {
            try {
                products = JSON.parse(products);
            } catch (e) {
                console.error("Kh√¥ng th·ªÉ parse JSON:", e, products);
                products = [];
            }
        }
        /*]]>*/
    </script>

    <!-- ========== SCRIPT pagination client-side ========== -->
    <script>


        document.addEventListener("DOMContentLoaded", () => {
            const paginationContainer = document.getElementById("pagination");
            const prevBtn = document.getElementById("prev-btn");
            const nextBtn = document.getElementById("next-btn");
            const path = window.location.pathname;
            const lang = path.split("/")[1];
            const validLangs = ["vi", "en"];
            if (!validLangs.includes(lang)) {
                const newUrl = `${window.location.origin}/vi`;
                window.location.replace(newUrl);
            } else {
                console.log("üåê Current language:", lang);
            }

            if (!Array.isArray(products)) {
                console.error("Products is not an array:", products);
                products = [];
            }

            let currentPage = 0;
            let itemsPerPage = getItemsPerPage();

            function getItemsPerPage() {
                if (window.innerWidth >= 992) return 12; // Desktop
                if (window.innerWidth >= 768) return 8;  // Tablet
                return 4;                               // Mobile
            }
            function getFirstImage(product) {
                try {
                    if (product.images && product.images.length > 0) return product.images[0];
                } catch (e) { }
                return '/image/No_image_available.svg.webp';
            }

            function getbtn(lang) {
                if (lang === "en" || lang === "EN") {
                    return "Buy"
                }
                return "Mua"

            }

            function getPrice(product) {
                try {
                    if (product.variants && product.variants.length > 0)
                        return formatPrice(product.variants[0].price);
                } catch (e) {}
                return product.defaultPrice ? formatPrice(product.defaultPrice) : "Li√™n h·ªá";
            }

            function formatPrice(price) {
                if (typeof price !== 'number') {
                    price = parseFloat(price);
                    if (isNaN(price)) return "Li√™n h·ªá";
                }

                const formatted = price.toLocaleString('vi-VN');
                return `${formatted} VNƒê`;
            }

            function escapeHtml(str) {
                if (typeof str !== 'string') return str == null ? '' : str;
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            let lastDirection = 'next';

            function renderProducts() {
                const start = currentPage * itemsPerPage;
                const end = start + itemsPerPage;
                const currentProducts = products.slice(start, end);
                const direction = lastDirection === 'next' ? -1 : 1;

                const container = document.getElementById('product-list');
                if (!container) return;

                // ƒê·∫£m b·∫£o container c√≥ position ƒë·ªÉ tr√°nh layout shift
                container.style.position = 'relative';
                container.style.overflow = 'hidden';

                // Th√™m l·ªõp animation
                container.classList.add('slide-out');
                container.style.transform = `translateX(${direction * 20}px)`; // tr∆∞·ª£t nh·∫π
                container.style.opacity = '0';

                // Sau khi fade-out xong, thay n·ªôi dung
                setTimeout(() => {
                    // C·∫≠p nh·∫≠t n·ªôi dung (kh√¥ng th√™m container m·ªõi)
                    container.innerHTML = currentProducts.map(product => `
                    <div class="product-content-col col-xs-6 col-sm-6 col-md-6 col-lg-4 col-xl-3">
                        <a href="${lang}/product/${product.id}" class="product-link text-decoration-none text-dark">
                            <div class="product-content-detail">
                                <div class="image-content">
                                    <div class="image-detail d-flex flex-column">
                                        <div class="icon d-flex justify-content-end">
                                            <i class="fa-solid fa-plus"></i>
                                        </div>
                                        <div class="image d-flex align-items-center justify-content-center">
                                            <div>
                                                <img src="${escapeHtml(getFirstImage(product))}"
                                                     alt="${escapeHtml(product.name || '')}" class="h-100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-content">
                                    <div class="text-detail d-flex flex-column fw-bolder">
                                        <div class="text-title">${escapeHtml(product.name || '')}</div>
                                        <div class="detail d-flex align-items-center justify-content-between">
                                            <div class="text-price">
                                                <span class="price-value">${escapeHtml(getPrice(product))}</span>
                                            </div>
                                            <div class="buy-btn">${getbtn(lang)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
        `).join('');

                    // Reset animation r·ªìi fade-in m∆∞·ª£t
                    container.style.transition = 'none';
                    container.style.transform = `translateX(${direction * -20}px)`;
                    container.offsetHeight; // force reflow
                    container.style.transition = 'transform 0.4s ease, opacity 0.4s ease';
                    container.style.transform = 'translateX(0)';
                    container.style.opacity = '1';
                }, 200);
            }


            function renderPagination() {
                paginationContainer.innerHTML = '';
                const totalPages = Math.max(1, Math.ceil(products.length / itemsPerPage));

                const maxVisible = 7;
                let startPage = 0;
                let endPage = totalPages - 1;

                if (totalPages > maxVisible) {
                    const around = 2;
                    startPage = Math.max(0, currentPage - around);
                    endPage = Math.min(totalPages - 1, currentPage + around);

                    if (startPage === 0) endPage = maxVisible - 1;
                    if (endPage === totalPages - 1) startPage = totalPages - maxVisible;
                }

                if (startPage > 0) {
                    paginationContainer.appendChild(makePageItem(0));
                    if (startPage > 1) paginationContainer.appendChild(makeEllipsis());
                }

                for (let i = startPage; i <= endPage; i++) {
                    paginationContainer.appendChild(makePageItem(i));
                }

                if (endPage < totalPages - 1) {
                    if (endPage < totalPages - 2) paginationContainer.appendChild(makeEllipsis());
                    paginationContainer.appendChild(makePageItem(totalPages - 1));
                }

                updateArrowButtons(totalPages);
            }

            function makePageItem(i) {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (i === currentPage) li.classList.add('active');

                const a = document.createElement('a');
                a.classList.add('page-link');
                a.href = '#';
                a.textContent = (i + 1);
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (i === currentPage) return;
                    currentPage = i;
                    renderProducts();
                    renderPagination();
                    scrollStay();
                });

                li.appendChild(a);
                return li;
            }

            function makeEllipsis() {
                const li = document.createElement('li');
                li.classList.add('page-item', 'disabled');
                const span = document.createElement('span');
                span.classList.add('page-link');
                span.style.padding = "4px 8px";
                span.textContent = '...';
                li.appendChild(span);
                return li;
            }

            function updateArrowButtons(totalPages) {
                prevBtn.style.visibility = currentPage === 0 ? 'hidden' : 'visible';
                nextBtn.style.visibility = currentPage >= totalPages - 1 ? 'hidden' : 'visible';
            }

            function scrollStay() {
                const sectionTop = document.querySelector('.product-section').offsetTop;
                window.scrollTo({ top: sectionTop, behavior: 'instant' });
            }

            // G√°n s·ª± ki·ªán cho n√∫t tr√°i/ph·∫£i
            prevBtn.addEventListener('click', () => {
                if (currentPage > 0) {
                    lastDirection = 'prev';
                    currentPage--;
                    renderProducts();
                    renderPagination();
                    scrollStay();
                }
            });

            nextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(products.length / itemsPerPage);
                if (currentPage < totalPages - 1) {
                    lastDirection = 'next';
                    currentPage++;
                    renderProducts();
                    renderPagination();
                    scrollStay();
                }
            });

            let resizeTimer = null;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    const newSize = getItemsPerPage();
                    if (newSize !== itemsPerPage) {
                        itemsPerPage = newSize;
                        currentPage = 0;
                        renderProducts();
                        renderPagination();
                    }
                }, 150);
            });

            renderProducts();
            renderPagination();
        });
    </script>
</th:block>
</body>
</html>

