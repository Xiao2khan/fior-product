<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/website/main}">
<head>
    <link rel="stylesheet" th:href="@{/css/website/order.css}">
</head>
<body>
<div layout:fragment="website-content">
    <div class="container breadcrumb" style="margin-top:30px;padding: 12px;font-size:14px;font-weight: 600">
        <div>
            <p>Trang Chủ > Giỏ Hàng > Đặt Hàng</p>
        </div>
    </div>
    <div class="container cart-page">
        <h3 class="fw-bold mb-4">Đặt hàng</h3>
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="info-box">
                    <h5 class="fw-bold mb-4">Thông tin khách hàng</h5>
                    <form class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Họ và tên</label>
                            <input type="text" class="form-control" placeholder="Nguyễn Văn An" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Số điện thoại</label>
                            <input type="text" class="form-control" placeholder="0912345678" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control w-100" placeholder="abc@gmail.com" style="height: auto; box-shadow: unset;"/>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Thành phố / tỉnh</label>
                            <input type="text" class="form-control" placeholder="Hà Nội" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Quận / huyện</label>
                            <input type="text" class="form-control" placeholder="Quận Đống Đa" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Phường / xã</label>
                            <input type="text" class="form-control" placeholder="Phường Nam Đồng" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tổ dân phố / thôn</label>
                            <input type="text" class="form-control" placeholder="65/5 Xã Đàn" />
                        </div>
                    </form>
                </div>
            </div>
            <!-- Đơn hàng -->
            <div class="col-lg-4">
                <div class="card p-4">
                    <div>
                        <h5 class="fw-bold mb-3">Đơn hàng của bạn</h5>
                        <div class="total">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tổng tất cả sản phẩm:</span>
                                <span id="subtotal">0đ</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí vận chuyển:</span>
                                <span id="shipping">100.000đ</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold">
                                <span style="color:#2C6E1F">Tổng:</span>
                                <span id="price_total" class="text-success">0đ</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-success w-100 mt-4" style="background: #2C6E1F">Đặt hàng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const subtotalEl = document.getElementById("subtotal");
            const totalEl = document.getElementById("price_total");
            const orderButton = document.querySelector(".btn-success");
            const shipping = 100000;
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let lang = window.location.pathname.split("/")[1] || "vi";
            let subtotal = 0;
            cart.forEach((item) => subtotal += item.price * item.quantity);
            subtotalEl.textContent = subtotal.toLocaleString("vi-VN") + "đ";
            totalEl.textContent = (subtotal + shipping).toLocaleString("vi-VN") + "đ";

            const mappedItems = cart.map(item => {
                const numberMatch = item.variantText.match(/(\d+)/);
                const textMatch = item.variantText.replace(/\d+/g, "").trim();

                const size = numberMatch ? parseInt(numberMatch[1]) : 0;
                const unit = textMatch || "gram";

                return {
                    productId: item.id,
                    productName: item.name,
                    variantName: item.variantText,
                    size,
                    price: item.price,
                    variantId:item.variantId,
                    unit,
                    quantity: item.quantity,
                    image: item.image
                };
            });

            orderButton.addEventListener("click", async (event) => {
                event.preventDefault();

                const form = document.querySelector("form");
                const formData = {
                    fullName: form.querySelector("input[placeholder='Nguyễn Văn An']").value,
                    phone: form.querySelector("input[placeholder='0912345678']").value,
                    email: form.querySelector("input[placeholder='abc@gmail.com']").value,
                    city: form.querySelector("input[placeholder='Hà Nội']").value,
                    district: form.querySelector("input[placeholder='Quận Đống Đa']").value,
                    ward: form.querySelector("input[placeholder='Phường Nam Đồng']").value,
                    street: form.querySelector("input[placeholder='65/5 Xã Đàn']").value
                };

                if (!formData.fullName || !formData.phone || !formData.email || !formData.city || !formData.district || !formData.ward) {
                    alert("Vui lòng điền đầy đủ thông tin!");
                    return;
                }

                const orderData = {
                    customer: formData,
                    items: mappedItems,
                    subtotal: subtotal,
                    shipping: shipping,
                    total: subtotal + shipping
                };

                try {
                    const response = await fetch("/api/orders", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(orderData)
                    });

                    if (response.ok) {
                        localStorage.removeItem("cart");
                        window.location.href = `/${lang}/order/success`;
                    } else {
                        const error = await response.json();
                        alert("Lỗi khi đặt hàng: " + error.message);
                    }
                } catch (error) {
                    console.error("Lỗi:", error);
                    alert("Đã có lỗi xảy ra, vui lòng thử lại!");
                }
            });
        });
    </script>
</th:block>
</body>
</html>