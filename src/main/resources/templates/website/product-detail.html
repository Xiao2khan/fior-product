<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/website/main}">
<head>
    <link rel="stylesheet" th:href="@{/css/website/product-detail.css}">
    <link rel="stylesheet" th:href="@{/css/website/product-page.css}">
</head>
<body>
<div layout:fragment="website-content">
    <div class="breadcrumb-banner">
        <img src="/image/breadcrumb.jpg" alt="breadcrumb background">
        <div class="breadcrumb-content">
            <h1 th:text="#{productDetail}"></h1>
            <p><a th:href="@{/{lang}(lang=${#locale.language})}"><span th:text="#{home}"></span></a> >
                <a th:href="@{/{lang}/products(lang=${#locale.language})}"><span th:text="#{products}"></span></a> >
                <span th:text="#{productDetail}"></span>
            </p>
        </div>
    </div>

    <section class="product-section container">
        <div class="product-detail d-flex" style="gap:64px">
            <div class="product-gallery">
                <div class="main-image">
                    <img id="main-image"
                         th:src="${!#lists.isEmpty(product.images) ? product.images[0] : '/image/No_image_available.svg.webp'}"
                         alt="Ảnh sản phẩm">
                </div>
                <div class="thumbnail-list">
                    <img th:each="img : ${product.images}"
                         th:src="${img}"
                         alt="Ảnh phụ"
                         onclick="document.getElementById('main-image').src = this.src"
                         class="thumbnail">
                </div>
            </div>
            <div class="product-info">
                <div class="d-flex flex-column gap-12">
                    <div class="d-flex flex-column gap-12">
                        <h1 class="product-name" id="product-name" th:text="${product.name}" style="font-size: 40px;color:#2C6E1F"></h1>
                        <p class="stock-status"
                           th:text="${!#lists.isEmpty(product.variants) ? (product.variants[0].instock ? 'Còn hàng' : 'Hết hàng') : (product.inStock ? 'Còn hàng' : 'Hết hàng')}"
                           th:classappend="${!#lists.isEmpty(product.variants) ? (product.variants[0].instock ? ' in-stock' : ' out-stock') : (product.inStock ? ' in-stock' : ' out-stock')}">
                        </p>
                    </div>
                    <p class="price" style="color:#020808">
                        Giá:
                        <span id="price" style="color: #2C6E1F;"
                              th:text="${(product.variants != null and !#lists.isEmpty(product.variants))
                                         ? product.variants[0].price
                                         : product.defaultPrice}">
                        </span><span style="color: #2C6E1F;">VNĐ</span>
                    </p>
                    <div class="d-flex flex-column" style="gap:32px;font-weight: 600">
                        <div class="variant-quantity">
                            <div class="quantity d-flex flex-column">
                                <span th:text="#{quantity}">Số Lượng</span>
                                <div class="quantity-control">
                                    <button type="button" onclick="changeQty(-1)">−</button>
                                    <input id="quantity" value="1" min="1">
                                    <button type="button" onclick="changeQty(1)">+</button>
                                </div>
                            </div>
                            <div class="variant d-flex flex-column">
                                <span th:text="#{size}"></span>
                                <div th:if="${!#lists.isEmpty(product.variants)}">
                                    <select id="variant-select">
                                        <option th:each="variant,iterStat : ${product.variants}"
                                                th:value="${variant.id}"
                                                th:data-price="${variant.price}"
                                                th:data-stock="${variant.instock}"
                                                th:text="${variant.size + ' ' + variant.unit}"
                                                th:selected="${selectedVariant != null ? (variant.id == selectedVariant.id) : (iterStat.index == 0)}">
                                        </option>
                                    </select>
                                </div>

                                <div th:if="${#lists.isEmpty(product.variants)}" hidden>
                                    <select id="variant-select">
                                        <option th:value="${product.id}"
                                                th:data-price="${product.defaultPrice}"
                                                th:data-stock="${product.inStock}" th:text="#{default}">

                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="action-buttons d-flex flex-column" style="gap:32px">
                            <button class="btn btn-cart" style="max-width:395px;height:56px" th:disabled="${!#lists.isEmpty(product.variants) ? !product.variants[0].instock : !product.inStock}">Thêm vào giỏ hàng</button>
                            <button class="btn btn-buy" style="height:80px" th:disabled="${!#lists.isEmpty(product.variants) ? !product.variants[0].instock : !product.inStock}">Đặt hàng</button>
                            <input th:value="${product.id}" id="product-id" hidden>
                        </div>
                    </div>
                </div>
                <div class="product-desc" th:utext="${product.description}"></div>
            </div>
        </div>

        <div class="related-products">
            <div class="d-flex align-items-center justify-content-center position-relative mb-4">
                <h2 id="related-products-title" class="m-0 text-center flex-grow-1">Sản phẩm liên quan</h2>
                <div class="btn-page position-absolute d-flex align-items-center">
                    <div id="prev-btn" class="icon d-flex align-items-center justify-content-center">
                        <i class="fa-solid fa-arrow-left"></i>
                    </div>
                    <div id="next-btn" class="icon d-flex align-items-center justify-content-center">
                        <i class="fa-solid fa-arrow-right"></i>
                    </div>
                </div>
            </div>
            <div class="related-viewport">
                <div class="related-list d-flex" id="related-list">
                    <div class="product-content-col col-item" th:each="related: ${relatedProducts}">
                        <a th:href="|/${lang}/product/${related.id}|" class="product-link text-decoration-none text-dark">
                            <div class="product-content-detail">
                                <div class="image-content">
                                    <div class="image-detail d-flex flex-column">
                                        <div class="icon d-flex justify-content-end">
                                            <i class="fa-solid fa-plus"></i>
                                        </div>
                                        <div class="image d-flex align-items-center justify-content-center">
                                            <div style="width: 180px;height: 137px;">
                                                <img th:src="${!#lists.isEmpty(related.images) ? related.images[0] : '/image/No_image_available.svg.webp'}" alt="" class="h-100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-content">
                                    <div class="text-detail d-flex flex-column fw-bolder">
                                        <div class="text-title" th:text="${related.name}"></div>
                                        <div class="d-flex align-items-center justify-content-between detail">
                                            <div class="text-price">
                                                <span class="price-value"
                                                      th:text="${(related.variants != null and !#lists.isEmpty(related.variants))
                                                                 ? related.variants[0].price
                                                                 : related.defaultPrice}">
                                                </span> VNĐ
                                            </div>
                                            <div class="buy-btn" th:text="#{buy.btn}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            <!-- Pagination Dots -->
            <div id="pagination-dots" class="d-flex justify-content-center mt-3 gap-2"></div>
        </div>
    </section>
    <!-- Scripts -->
    <th:block layout:fragment="scripts">
        <script>

            function changeQty(delta) {
                const input = document.getElementById('quantity');
                let value = parseInt(input.value) + delta;
                if (value < 1) value = 1;
                input.value = value;
            }

            document.addEventListener('DOMContentLoaded', function () {
                const variantSelect = document.getElementById('variant-select');
                const priceEl = document.getElementById('price');
                const stockEl = document.querySelector('.stock-status');
                const cartBtn = document.querySelector('.btn-cart');
                const buyBtn = document.querySelector('.btn-buy');
                const titleEl = document.getElementById("related-products-title");
                if (titleEl) {
                    titleEl.textContent = t("relatedProducts");
                }

                function updateFromOption(option) {
                    if (!option) return;
                    const price = Number(option.dataset.price);
                    const inStock = option.dataset.stock === 'true';
                    console.log(option);
                    priceEl.textContent = new Intl.NumberFormat('vi-VN').format(price);
                    stockEl.textContent = inStock ? t("inStock") : t("outStock");
                    stockEl.className = inStock ? 'stock-status in-stock' : 'stock-status out-stock';
                    cartBtn.disabled = !inStock;
                    cartBtn.textContent = t("addToCart");
                    buyBtn.disabled = !inStock;
                    buyBtn.textContent = t("buy");
                }

                if (variantSelect) {
                    updateFromOption(variantSelect.options[variantSelect.selectedIndex]);

                    variantSelect.addEventListener('change', function () {
                        updateFromOption(this.options[this.selectedIndex]);
                    });
                }
            });
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const list = document.getElementById("related-list");
                const prevBtn = document.getElementById("prev-btn");
                const nextBtn = document.getElementById("next-btn");
                const dotsContainer = document.getElementById("pagination-dots");
                const products = Array.from(list.querySelectorAll(".product-content-col"));

                // Auto slide config
                let autoSlideInterval;
                const autoSlideDelay = 5000; // 5 giây

                // Responsive items per page
                function getItemsPerPage() {
                    const width = window.innerWidth;
                    if (width < 576) return 1;
                    if (width < 768) return 2;
                    if (width < 1200) return 3;
                    return 4;
                }

                let itemsPerPage = getItemsPerPage();
                const gapPx = 24;
                let totalPages = Math.ceil(products.length / itemsPerPage);
                let currentPage = 0;

                const buttonContainer = prevBtn.parentElement;
                buttonContainer.style.gap = '22px';
                list.style.flexWrap = 'nowrap';

                // Create pagination dots
                function createPaginationDots() {
                    dotsContainer.innerHTML = '';
                    for (let i = 0; i < totalPages; i++) {
                        const dot = document.createElement("div");
                        dot.className = "dot";
                        dot.addEventListener("click", () => {
                            currentPage = i;
                            updateProducts();
                            startAutoSlide(); // restart timer
                        });
                        dotsContainer.appendChild(dot);
                    }
                }

                // Update display
                function updateProducts() {
                    const totalGapPerPage = (itemsPerPage - 1) * gapPx;
                    const basis = `calc((100% - ${totalGapPerPage}px) / ${itemsPerPage})`;

                    products.forEach((p) => {
                        p.style.flex = `0 0 ${basis}`;
                        p.style.maxWidth = basis;

                        if (window.innerWidth < 576) {
                            p.style.flex = "0 0 100%";
                            p.style.maxWidth = "100%";
                        }
                    });

                    let offset = 0;
                    const numPrevItems = currentPage * itemsPerPage;
                    for (let i = 0; i < numPrevItems; i++) {
                        offset += products[i].offsetWidth;
                        if (i < numPrevItems - 1) offset += gapPx;
                    }

                    list.style.transform = `translateX(-${offset}px)`;

                    // Update buttons
                    prevBtn.style.opacity = currentPage === 0 ? "0.4" : "1";
                    prevBtn.style.pointerEvents = currentPage === 0 ? "none" : "auto";
                    nextBtn.style.opacity = currentPage === totalPages - 1 ? "0.4" : "1";
                    nextBtn.style.pointerEvents = currentPage === totalPages - 1 ? "none" : "auto";

                    // Update dots
                    document.querySelectorAll(".dot").forEach((dot, i) => {
                        dot.classList.toggle("active", i === currentPage);
                    });
                }

                // Auto slide
                function startAutoSlide() {
                    clearInterval(autoSlideInterval);
                    autoSlideInterval = setInterval(() => {
                        currentPage++;
                        if (currentPage >= totalPages) currentPage = 0;
                        updateProducts();
                    }, autoSlideDelay);
                }

                // Resize
                function handleResize() {
                    const newItemsPerPage = getItemsPerPage();
                    if (newItemsPerPage !== itemsPerPage) {
                        itemsPerPage = newItemsPerPage;
                        totalPages = Math.ceil(products.length / itemsPerPage);
                        currentPage = Math.min(currentPage, totalPages - 1);
                        list.style.transition = 'none';
                        updateProducts();
                        createPaginationDots();
                        setTimeout(() => {
                            list.style.transition = 'transform 0.5s ease';
                        }, 0);
                    }
                }

                // Buttons
                prevBtn.addEventListener("click", () => {
                    if (currentPage > 0) {
                        currentPage--;
                        updateProducts();
                        startAutoSlide();
                    }
                });

                nextBtn.addEventListener("click", () => {
                    if (currentPage < totalPages - 1) {
                        currentPage++;
                        updateProducts();
                        startAutoSlide();
                    }
                });

                // Pause on hover
                [prevBtn, nextBtn, list].forEach(el => {
                    el.addEventListener('mouseenter', () => clearInterval(autoSlideInterval));
                    el.addEventListener('mouseleave', startAutoSlide);
                });

                window.addEventListener('resize', handleResize);

                // Init
                createPaginationDots();
                updateProducts();
                startAutoSlide();
            });
        </script>
        <script>
            function getCart() {
                try {
                    const raw = localStorage.getItem("cart");
                    if (!raw || raw === "null" || raw === "undefined") return [];
                    const parsed = JSON.parse(raw);
                    if (!Array.isArray(parsed)) return [];
                    return parsed.filter(
                        (item) =>
                            item != null &&
                            typeof item === "object" &&
                            typeof item.id === "string" &&
                            typeof item.variantId === "string" &&
                            typeof item.quantity === "number"
                    );
                } catch (e) {
                    console.warn("⚠️ Lỗi khi đọc localStorage.cart:", e);
                    return [];
                }
            }

            function saveCart(cart) {
                try {
                    if (!Array.isArray(cart) || cart.length === 0) {
                        localStorage.removeItem("cart");
                        updateCartCount(); // cập nhật icon
                        return;
                    }
                    localStorage.setItem("cart", JSON.stringify(cart));
                    updateCartCount();
                } catch (e) {
                    console.error(e);
                }
            }

            function addToCart(product) {
                if (
                    !product ||
                    typeof product !== "object" ||
                    !product.id ||
                    !product.variantId ||
                    typeof product.quantity !== "number"
                ) {
                    console.warn("❌ Sản phẩm không hợp lệ:", product);
                    return;
                }

                let cart = getCart();
                const index = cart.findIndex(
                    (item) => item && item.id === product.id && item.variantId === product.variantId
                );

                if (index !== -1) {
                    cart[index].quantity += product.quantity;
                } else {
                    cart.push(product);
                }

                saveCart(cart);
            }

            function updateCartCount() {
                const cartCount = document.getElementById("cart-count");
                if (!cartCount) return;

                const cart = getCart();
                const count = cart.length;

                if (count > 0) {
                    cartCount.textContent = count;
                    cartCount.style.display = "flex";
                } else {
                    cartCount.style.display = "none";
                }
            }

            document.querySelector(".btn-cart")?.addEventListener("click", () => {
                const variantSelect = document.getElementById("variant-select");
                const productId = document.getElementById("product-id");
                const quantity = document.getElementById("quantity");

                if (!variantSelect || !productId || !quantity) return;

                const variantOption = variantSelect.options[variantSelect.selectedIndex];
                if (!variantOption || !variantOption.value || !variantOption.getAttribute("data-price")) return;

                const product = {
                    id: productId.value,
                    name: document.querySelector(".product-name")?.innerText || "Unknown",
                    variantId: variantOption.value,
                    variantText: variantOption.text,
                    price: parseInt(variantOption.getAttribute("data-price")),
                    quantity: parseInt(quantity.value) || 1,
                    image: document.getElementById("main-image")?.src || "/image/default.png",
                };

                addToCart(product);
                alert("🛒 Sản phẩm đã được thêm vào giỏ hàng!");
                updateCartCount();
            });

            document.querySelector(".btn-buy")?.addEventListener("click", () => {
                const variantSelect = document.getElementById("variant-select");
                const productId = document.getElementById("product-id");
                const quantity = document.getElementById("quantity");

                if (!variantSelect || !productId || !quantity) return;

                const variantOption = variantSelect.options[variantSelect.selectedIndex];
                if (!variantOption || !variantOption.value || !variantOption.getAttribute("data-price")) return;

                const product = {
                    id: productId.value,
                    name: document.querySelector(".product-name")?.innerText || "Unknown",
                    variantId: variantOption.value,
                    variantText: variantOption.text,
                    price: parseInt(variantOption.getAttribute("data-price")),
                    quantity: parseInt(quantity.value) || 1,
                    image: document.getElementById("main-image")?.src || "/image/default.png",
                };

                addToCart(product);
                const lang = window.location.pathname.split("/")[1] || "vi";
                window.location.href = `/${lang}/cart`;
            });

            (function initCart() {
                try {
                    const cart = getCart();
                    if (cart.length === 0) {
                        localStorage.removeItem("cart");
                    } else {
                        saveCart(cart);
                    }
                } catch (e) {
                    localStorage.removeItem("cart");
                }
                updateCartCount();
            })();
        </script>

    </th:block>
</div>
</body>
</html>