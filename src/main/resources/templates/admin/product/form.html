<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin/main}">

<head>
    <meta charset="UTF-8">
    <title>Product Form</title>

    <style>
        /* ✅ CKEditor */
        .ck-editor__editable_inline {
            min-height: 400px;
            overflow-y: hidden;
            transition: height 0.2s ease;
        }

        /* ✅ Category dropdown */
        .multi-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .multi-select .dropdown-btn {
            width: 100%;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: .375rem;
            padding: .5rem .75rem;
            text-align: left;
            cursor: pointer;
            white-space: normal;
        }

        .multi-select .dropdown-content {
            display: none;
            position: absolute;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: .375rem;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            padding: .5rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        }

        .multi-select.open .dropdown-content {
            display: block;
        }

        .form-check {
            margin-bottom: .25rem;
        }
    </style>
</head>

<body>
<div layout:fragment="admin-content">
    <h3 th:text="${product.id} != null ? 'Edit Product' : 'Create Product'"></h3>

    <form id="productForm" th:action="${product.id} != null ? @{'/admin/products/edit/' + ${product.id}} : @{/admin/products/create}"
          method="post"
          enctype="multipart/form-data"
          th:object="${product}">

        <div class="row g-3">

            <!-- Name -->
            <div class="col-md-6">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" th:field="*{name}" required>
                <div class="text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
            </div>

            <!-- Default Price -->
            <div class="col-md-6">
                <label class="form-label">Default Price</label>
                <input type="number" class="form-control" th:field="*{defaultPrice}" min="0" step="0.01">
            </div>

            <!-- ✅ Categories -->
            <div class="col-12">
                <label class="form-label">Categories</label>
                <div class="multi-select" id="category-dropdown">
                    <button type="button" class="dropdown-btn" id="category-dropdown-btn">
                        Select categories
                    </button>
                    <div class="dropdown-content" id="category-dropdown-content">
                        <div id="category-options">
                            <div th:each="c : ${categories}" class="form-check">
                                <input class="form-check-input category-checkbox"
                                       type="checkbox"
                                       th:value="${c.id}"
                                       th:field="*{categoryId}"
                                       th:id="'cat__' + ${c.id}">
                                <label class="form-check-label"
                                       th:for="'cat__' + ${c.id}"
                                       th:text="${c.name}"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-danger" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}"></div>
            </div>

            <!-- Images -->
            <div class="row mt-3">
                <label class="form-label">Current Images</label>
                <div class="row" id="existingImages">
                    <div class="col-md-3 mb-3" th:each="img, iter : ${product.images}">
                        <div class="position-relative image-preview-wrapper">
                            <img th:src="@{${img}}"
                                 class="img-thumbnail w-100 preview-img"
                                 alt="Product Image"
                                 th:attr="data-index=${iter.index},data-src=${img}"
                                 onclick="openImageModal(this, 'existing')">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                                    onclick="removeExistingImage(this)" title="Remove image">&times;</button>
                            <input type="hidden" name="existingImages" th:value="${img}">
                        </div>
                    </div>
                </div>
                <div id="removedImagesContainer"></div>
            </div>

            <div class="form-group mt-3">
                <label class="form-label">Upload New Images</label>
                <input type="file" name="imageFiles" id="newImages" class="form-control" multiple accept="image/*">
                <div id="newImagePreview" class="row mt-2"></div>
            </div>

            <!-- Description -->
            <div class="col-12">
                <label class="form-label">Description</label>
                <textarea  id ="description-editor-default" class="form-control" th:field="*{description}" rows="6"></textarea>
                <div class="text-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
            </div>
            <div id="lang-container">
                <th:block th:if="${product.translations != null}">
                    <th:block th:each="t, iStat : ${product.translations}">
                        <div class="border p-3 rounded mb-3 bg-light position-relative lang-block">
                            <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                                    aria-label="Close"></button>
                            <h5 class="mb-3">English (en)</h5>
                            <input type="hidden" th:name="'translations[' + ${iStat.index} + '].language'" th:value="${t.language}">
                            <div class="mb-3">
                                <label class="form-label">Name (en)</label>
                                <input type="text" class="form-control"
                                       th:name="'translations[' + ${iStat.index} + '].name'"
                                       th:value="${t.name}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description (en)</label>
                                <textarea class="description-editor form-control"
                                          th:name="'translations[' + ${iStat.index} + '].description'"
                                          rows="3"
                                          th:text="${t.description}"></textarea>
                            </div>
                        </div>
                    </th:block>
                </th:block>
            </div>

            <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-outline-primary" id="add-lang-btn">
                    <i class="fa fa-plus me-1"></i> Add English (en)
                </button>
            </div>

            <!-- ✅ Variants -->
            <div class="col-12 mt-4">
                <h5 class="d-flex justify-content-between align-items-center">
                    <span>Variants</span>
                    <button type="button" class="btn btn-sm btn-success" id="add-variant-btn">
                        <i class="fa fa-plus"></i> Add Variant
                    </button>
                </h5>

                <div id="variant-container">
                    <input type="hidden" name="removedVariantIds" id="removedVariantIds" value="">
                    <div th:each="v, i : ${product.variants}" class="card p-3 mb-3">
                        <input type="hidden" th:name="'variants[' + ${i.index} + '].id'" th:value="${v.id}">

                        <div class="row g-3 align-items-end">

                            <!-- Size -->
                            <div class="col-md-3">
                                <label class="form-label">Size</label>
                                <input type="number" class="form-control"
                                       th:name="'variants[' + ${i.index} + '].size'"
                                       th:value="${v.size}" required>
                            </div>

                            <!-- Unit Select -->
                            <div class="col-md-3">
                                <label class="form-label">Unit</label>
                                <select class="form-select unit-select" th:attr="data-index=${i.index}">
                                    <option value="gram"
                                            th:selected="${v.unit == null or v.unit == 'gram'}">Gram</option>
                                    <option value="kilogram"
                                            th:selected="${v.unit == 'kilogram'}">Kilogram</option>
                                    <option value="ml"
                                            th:selected="${v.unit == 'ml'}">Milliliter (ml)</option>
                                    <option value="l"
                                            th:selected="${v.unit == 'l'}">Liter (L)</option>
                                    <option value="custom"
                                            th:selected="${v.unit != null and !(#lists.contains({'gram','kilogram','ml','l'}, v.unit))}">
                                        Other...
                                    </option>
                                </select>
                            </div>

                            <!-- Custom Unit -->
                            <div class="col-md-3">
                                <label class="form-label">Custom Unit</label>
                                <input type="text" class="form-control custom-unit"
                                       placeholder="e.g. pack, piece"
                                       th:value="${(v.unit != null and !(#lists.contains({'gram','kilogram','ml','l'}, v.unit))) ? v.unit : ''}"
                                       th:attr="data-index=${i.index}"
                                       th:disabled="${v.unit == null or #lists.contains({'gram','kilogram','ml','l'}, v.unit)}">
                            </div>

                            <!-- Price -->
                            <div class="col-md-2">
                                <label class="form-label">Price (VND)</label>
                                <input type="number" step="0.01" min="0" class="form-control"
                                       th:name="'variants[' + ${i.index} + '].price'"
                                       th:value="${v.price}" required>
                            </div>

                            <!-- Instock -->
                            <div class="col-md-1 d-flex align-items-center justify-content-center">
                                <div class="form-check mt-3">
                                    <input type="checkbox" class="form-check-input"
                                           th:name="'variants[' + ${i.index} + '].instock'"
                                           th:checked="${v.instock}">
                                    <label class="form-check-label">In stock</label>
                                </div>
                            </div>

                            <!-- Hidden field cho unit -->
                            <input type="hidden" th:name="'variants[' + ${i.index} + '].unit'"
                                   th:value="${v.unit != null ? v.unit : 'gram'}"
                                   class="unit-hidden">

                            <!-- Remove button -->
                            <div class="col-md-12 text-end">
                                <button type="button" class="btn btn-danger btn-sm remove-variant"
                                        th:data-variant-id="${v.id}">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Submit -->
            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-save me-1"></i> Save
                </button>
                <a th:href="@{/admin/products}" class="btn btn-secondary">Back</a>
            </div>
        </div>
    </form>
</div>

<!-- ✅ Scripts -->
<th:block layout:fragment="scripts">
    <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>

    <script th:inline="javascript">
        (function () {
            // Biến dùng chung
            const container = document.getElementById('variant-container');
            const removedVariantIdsInput = document.getElementById('removedVariantIds');
            const addBtn = document.getElementById('add-variant-btn');

            // Kiểm tra xem các phần tử có tồn tại không
            if (!container || !removedVariantIdsInput || !addBtn) {
                console.error('Không tìm thấy #variant-container, #removedVariantIds hoặc #add-variant-btn');
                return;
            }

            // Khởi tạo variantIndex dựa trên số lượng thẻ .card hiện có
            let variantIndex = container.querySelectorAll('.card').length;

            // Xử lý nút Add Variant
            addBtn.addEventListener('click', () => {
                const html = `
                <div class="card p-3 mb-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Size</label>
                            <input type="number" class="form-control" name="variants[${variantIndex}].size" required>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Unit</label>
                            <select class="form-select unit-select" data-index="${variantIndex}">
                                <option value="gram" selected>Gram</option>
                                <option value="kilogram">Kilogram</option>
                                <option value="ml">Milliliter (ml)</option>
                                <option value="l">Liter (L)</option>
                                <option value="custom">Other...</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Custom Unit</label>
                            <input type="text" class="form-control custom-unit"
                                   placeholder="e.g. pack, piece" data-index="${variantIndex}" disabled>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Price (VND)</label>
                            <input type="number" class="form-control" name="variants[${variantIndex}].price" step="0.01" min="0" required>
                        </div>

                        <div class="col-md-1 d-flex align-items-center justify-content-center">
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input"
                                       name="variants[${variantIndex}].instock" id="instock_${variantIndex}" checked>
                                <label class="form-check-label" for="instock_${variantIndex}">In stock</label>
                            </div>
                        </div>

                        <!-- hidden field để đồng bộ unit -->
                        <input type="hidden" name="variants[${variantIndex}].unit" class="unit-hidden" value="gram">

                        <div class="col-md-12 text-end">
                            <button type="button" class="btn btn-danger btn-sm remove-variant">Remove</button>
                        </div>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
                variantIndex++;
                updateVariantIndexes(); // Cập nhật chỉ số sau khi thêm
            });

            // Xử lý nút Remove Variant
            container.addEventListener('click', e => {
                if (e.target.classList.contains('remove-variant')) {
                    const card = e.target.closest('.card');
                    if (!card) {
                        console.warn('Không tìm thấy thẻ .card chứa nút remove-variant');
                        return;
                    }

                    const variantId = e.target.getAttribute('data-variant-id');
                    if (variantId) {
                        let removedIds = removedVariantIdsInput.value ? removedVariantIdsInput.value.split(',').filter(id => id) : [];
                        if (!removedIds.includes(variantId)) {
                            removedIds.push(variantId);
                            removedVariantIdsInput.value = removedIds.join(',');
                        }
                    }

                    card.remove();
                    updateVariantIndexes(); // Cập nhật chỉ số sau khi xóa
                }
            });

            // Hàm cập nhật chỉ số cho các input
            function updateVariantIndexes() {
                const cards = container.querySelectorAll('.card');
                cards.forEach((card, index) => {
                    const inputs = card.querySelectorAll('input');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.startsWith('variants[')) {
                            const newName = name.replace(/variants\[\d+\]/, `variants[${index}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                    // Cập nhật id và for của checkbox instock
                    const checkbox = card.querySelector('.form-check-input');
                    if (checkbox) {
                        checkbox.id = `instock_${index}`;
                        const label = card.querySelector('.form-check-label');
                        if (label) {
                            label.setAttribute('for', `instock_${index}`);
                        }
                    }
                });
            }

            // Giữ nguyên các phần JavaScript khác
            let currentIndex = 0;
            let imageSources = [];
            let newImageFiles = [];

            function openImageModal(img, group) {
                const selector = group === 'existing'
                    ? '#existingImages img.preview-img'
                    : '#newImagePreview img.preview-img';
                const allImages = document.querySelectorAll(selector);
                imageSources = Array.from(allImages).map(i => i.getAttribute('data-src'));
                currentIndex = parseInt(img.getAttribute('data-index'));
                document.getElementById('modalImage').src = imageSources[currentIndex];
                const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                modal.show();
            }

            function nextImage() {
                currentIndex = (currentIndex + 1) % imageSources.length;
                document.getElementById('modalImage').src = imageSources[currentIndex];
            }

            function prevImage() {
                currentIndex = (currentIndex - 1 + imageSources.length) % imageSources.length;
                document.getElementById('modalImage').src = imageSources[currentIndex];
            }

            function removeExistingImage(button) {
                const container = button.closest('.col-md-3');
                const input = container.querySelector('input[name="existingImages"]');
                const value = input.value;
                const removedInput = document.createElement('input');
                removedInput.type = 'hidden';
                removedInput.name = 'removedImages';
                removedInput.value = value;
                document.getElementById('removedImagesContainer').appendChild(removedInput);
                container.remove();
            }

            document.getElementById('newImages').addEventListener('change', function (event) {
                newImageFiles = newImageFiles.concat(Array.from(event.target.files));
                renderNewImagesPreview();
                updateNewImagesInput();
            });

            function renderNewImagesPreview() {
                const previewContainer = document.getElementById('newImagePreview');
                previewContainer.innerHTML = '';
                newImageFiles.forEach((file, idx) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 mb-3';
                        col.innerHTML = `
                            <div class="position-relative image-preview-wrapper">
                                <img src="${e.target.result}"
                                     class="img-thumbnail w-100 preview-img"
                                     alt="Preview"
                                     data-src="${e.target.result}"
                                     data-index="${idx}"
                                     onclick="openImageModal(this, 'new')">
                                <button type="button" class="remove-btn btn btn-sm btn-danger position-absolute top-0 end-0 m-1" onclick="removeNewImage(${idx})">×</button>
                            </div>`;
                        previewContainer.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });
            }

            window.removeNewImage = function (index) {
                newImageFiles.splice(index, 1);
                renderNewImagesPreview();
                updateNewImagesInput();
            };

            function updateNewImagesInput() {
                const dataTransfer = new DataTransfer();
                newImageFiles.forEach(file => dataTransfer.items.add(file));
                document.getElementById('newImages').files = dataTransfer.files;
            }

            const el = document.querySelector('#description-editor-default');
            if (el) {
                ClassicEditor.create(el)
                    .then(editor => {
                        const editable = editor.ui.view.editable.element;
                        const resize = () => {
                            editable.style.height = 'auto';
                            editable.style.height = editable.scrollHeight + 'px';
                        };
                        editor.model.document.on('change:data', resize);
                        resize();
                    })
                    .catch(err => console.error(err));
            }


            (function () {
                const dropdown = document.getElementById('category-dropdown');
                const btn = document.getElementById('category-dropdown-btn');
                const content = document.getElementById('category-dropdown-content');
                const checkboxes = content.querySelectorAll('.category-checkbox');

                function updateButtonText() {
                    const selected = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => {
                            const label = document.querySelector(`label[for="${cb.id}"]`);
                            return label ? label.textContent.trim() : '';
                        })
                        .filter(text => text !== '');
                    btn.textContent = selected.length === 0 ? 'Select categories' : selected.join(', ');
                }

                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    dropdown.classList.toggle('open');
                });

                document.addEventListener('click', e => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('open');
                    }
                });

                checkboxes.forEach(cb => cb.addEventListener('change', updateButtonText));
                window.addEventListener('load', updateButtonText);
            })();

            document.addEventListener("DOMContentLoaded", () => {
                const container = document.getElementById('variant-container');
                const form = document.getElementById('productForm');
                console.log(form.action)

                function showError(card, message) {
                    let errorDiv = card.querySelector('.variant-error');
                    if (!errorDiv) {
                        const row = card.querySelector('.row');
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'variant-error text-danger mt-2 small d-flex align-items-center';
                        errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${message}`;
                        row.insertAdjacentElement('afterend', errorDiv);
                    } else {
                        errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${message}`;
                    }
                }

                function clearError(card) {
                    const err = card.querySelector('.variant-error');
                    if (err) err.remove();
                }

                function getVariantKey(card) {
                    const size = card.querySelector('input[name*=".size"]').value.trim();
                    const unitSelect = card.querySelector('.unit-select');
                    const customUnit = card.querySelector('.custom-unit');
                    const unitHidden = card.querySelector('.unit-hidden');

                    let unit = '';
                    if (unitSelect.value === 'custom') {
                        unit = customUnit.value.trim();
                    } else {
                        unit = unitSelect.value.trim();
                    }

                    unitHidden.value = unit || 'gram';
                    return `${size}__${unitHidden.value}`;
                }

                function validateDuplicates() {
                    const cards = Array.from(container.querySelectorAll('.card'));
                    const seen = new Map();
                    let hasDuplicate = false;

                    cards.forEach(clearError);

                    for (const card of cards) {
                        const key = getVariantKey(card);
                        const [size, unit] = key.split('__');

                        if (!size) continue;

                        if (seen.has(key)) {
                            hasDuplicate = true;
                            showError(card, `❌ Variant với Size "${size}" và Unit "${unit}" đã tồn tại.`);
                            showError(seen.get(key), `❌ Variant với Size "${size}" và Unit "${unit}" đã tồn tại.`);
                        } else {
                            seen.set(key, card);
                        }
                    }

                    return hasDuplicate;
                }
                container.addEventListener('click', e => {
                    if (e.target.closest('.remove-variant')) {
                        const card = e.target.closest('.card');
                        if (card) {
                            card.remove();
                            console.log("🗑️ Removed variant, revalidating...");
                            validateDuplicates();
                        }
                    }
                });
                container.addEventListener('input', e => {
                    if (e.target.matches('input[name*=".size"], .custom-unit')) {
                        validateDuplicates();
                    }
                });

                container.addEventListener('change', e => {
                    if (e.target.matches('.unit-select')) {
                        const card = e.target.closest('.card');
                        const customUnit = card.querySelector('.custom-unit');
                        if (e.target.value === 'custom') {
                            customUnit.disabled = false;
                            customUnit.focus();
                        } else {
                            customUnit.disabled = true;
                            customUnit.value = '';
                        }
                        validateDuplicates();
                    }
                });

                form.addEventListener('submit', e => {
                    const hasDup = validateDuplicates();
                    if (hasDup) {
                        e.preventDefault();
                        e.stopImmediatePropagation();

                        const firstError = container.querySelector('.variant-error');
                        if (firstError) {
                            const top = firstError.getBoundingClientRect().top + window.scrollY - 100;
                            window.scrollTo({ top, behavior: 'smooth' });
                        }
                        alert("⚠️ Có variant bị trùng Size + Unit. Vui lòng sửa trước khi lưu.");
                        return false;
                    }
                    return true;
                }, true);
            });
        })();

        document.addEventListener("DOMContentLoaded", () => {
            const addLangBtn = document.getElementById("add-lang-btn");
            const langContainer = document.getElementById("lang-container");

            // Ẩn nút "Add English" nếu block English đã tồn tại
            let enBlockExists = !!langContainer.querySelector("input[value='en']");
            if (enBlockExists) addLangBtn.style.display = "none";

            // Hàm khởi tạo CKEditor cho 1 textarea
            const initEditor = (textarea) => {
                ClassicEditor.create(textarea)
                    .then(editor => {
                        const editable = editor.ui.view.editable.element;
                        const resize = () => {
                            editable.style.height = 'auto';
                            editable.style.height = editable.scrollHeight + 'px';
                        };
                        editor.model.document.on('change:data', resize);
                        resize();
                    })
                    .catch(err => console.error("CKEditor init error:", err));
            };

            // Khi nhấn "Add English"
            addLangBtn.addEventListener("click", () => {
                // Nếu đã có English rồi thì thoát
                if (langContainer.querySelector("input[value='en']")) return;

                const enBlock = document.createElement("div");
                enBlock.classList.add(
                    "border", "p-3", "rounded", "mb-3", "bg-light",
                    "position-relative", "lang-block"
                );

                enBlock.innerHTML = `
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close"></button>
            <h5 class="mb-3">English (en)</h5>
            <input type="hidden" name="translations[0].language" value="en">
            <div class="mb-3">
                <label class="form-label">Name (en)</label>
                <input type="text" class="form-control" name="translations[0].name" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Description (en)</label>
                <textarea class="description-editor form-control" name="translations[0].description" rows="3"></textarea>
            </div>
        `;

                langContainer.appendChild(enBlock);
                addLangBtn.style.display = "none"; // ẩn nút "Add English"

                // Khởi tạo CKEditor cho textarea mới
                const newTextarea = enBlock.querySelector(".description-editor");
                initEditor(newTextarea);
            });

            // 🧠 Event delegation — lắng nghe click trong toàn bộ container
            langContainer.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-close")) {
                    const langBlock = e.target.closest(".lang-block");
                    if (langBlock) {
                        langBlock.remove();
                        addLangBtn.style.display = "block"; // Hiện lại nút Add English
                    }
                }
            });

            // Nếu đã có các textarea sẵn (VD khi edit sản phẩm), khởi tạo CKEditor cho chúng
            langContainer.querySelectorAll(".description-editor").forEach(initEditor);
        });
        function openImageModal(img, group) {
            const selector = group === 'existing'
                ? '#existingImages img.preview-img'
                : '#newImagePreview img.preview-img';
            const allImages = document.querySelectorAll(selector);
            imageSources = Array.from(allImages).map(i => i.getAttribute('data-src'));
            currentIndex = parseInt(img.getAttribute('data-index'));
            document.getElementById('modalImage').src = imageSources[currentIndex];
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        function nextImage() {
            currentIndex = (currentIndex + 1) % imageSources.length;
            document.getElementById('modalImage').src = imageSources[currentIndex];
        }

        function prevImage() {
            currentIndex = (currentIndex - 1 + imageSources.length) % imageSources.length;
            document.getElementById('modalImage').src = imageSources[currentIndex];
        }

        function removeExistingImage(button) {
            const container = button.closest('.col-md-3');
            const input = container.querySelector('input[name="existingImages"]');
            const value = input.value;
            const removedInput = document.createElement('input');
            removedInput.type = 'hidden';
            removedInput.name = 'removedImages';
            removedInput.value = value;
            document.getElementById('removedImagesContainer').appendChild(removedInput);
            container.remove();
        }

    </script>
</th:block>
</body>
</html>
