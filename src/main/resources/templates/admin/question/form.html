<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/admin/main}">
<head>
    <meta charset="UTF-8">
    <title>Câu Hỏi</title>
</head>
<body>
<div layout:fragment="admin-content">
    <h3 th:text="${question.id} != null ? 'Edit Question' : 'Tạo câu hỏi'"></h3>

    <form th:action="${question.id} != null ? @{'/admin/questions/edit/' + ${question.id}} : @{/admin/questions/create}"
          method="post"
          th:object="${question}">

        <div class="mb-3">
            <label class="form-label">Tiêu đề</label>
            <input type="text" class="form-control" th:field="*{title}" required>
            <div class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Câu hỏi</label>
            <textarea class="form-control" rows="3" th:field="*{question}"></textarea>
            <div class="text-danger" th:if="${#fields.hasErrors('question')}" th:errors="*{question}"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Trả Lời</label>
            <textarea class="form-control" rows="3" th:field="*{answer}"></textarea>
            <div class="text-danger" th:if="${#fields.hasErrors('answer')}" th:errors="*{answer}"></div>
        </div>

        <div id="lang-container">
            <th:block th:if="${translations != null}">
                <th:block th:each="t, iStat : ${translations}">
                    <div class="border p-3 rounded mb-3 bg-light position-relative lang-block">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                                aria-label="Close"></button>
                        <h5 class="mb-3">English (en)</h5>
                        <input type="hidden" th:name="'translations[' + ${iStat.index} + '].language'" th:value="${t.language}">
                        <div class="mb-3">
                            <label class="form-label">Name (en)</label>
                            <input type="text" class="form-control"
                                   th:name="'translations[' + ${iStat.index} + '].title'"
                                   th:value="${t.title}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (en)</label>
                            <textarea class="form-control"
                                      th:name="'translations[' + ${iStat.index} + '].question'"
                                      rows="3"
                                      th:text="${t.question}"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (en)</label>
                            <textarea class="form-control"
                                      th:name="'translations[' + ${iStat.index} + '].answer'"
                                      rows="3"
                                      th:text="${t.answer}"></textarea>
                        </div>
                    </div>
                </th:block>
            </th:block>
        </div>

        <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-outline-primary" id="add-lang-btn">
                <i class="fa fa-plus me-1"></i> Thêm tiếng Anh (en)
            </button>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit"><i class="fa fa-save me-1"></i>Save</button>
            <a class="btn btn-secondary" th:href="@{/admin/question}">Back</a>
        </div>
    </form>
</div>

<th:block layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const addLangBtn = document.getElementById("add-lang-btn");
            const langContainer = document.getElementById("lang-container");

            // Bind sự kiện xóa cho các block có sẵn
            langContainer.querySelectorAll(".lang-block .btn-close").forEach(btn => {
                btn.addEventListener("click", () => {
                    btn.closest(".lang-block").remove();
                    addLangBtn.style.display = "block"; // hiện lại nút add nếu xóa block
                });
            });

            let enBlockExists = !!langContainer.querySelector("input[value='en']");
            if (enBlockExists) addLangBtn.style.display = "none";

            addLangBtn.addEventListener("click", () => {
                if (langContainer.querySelector("input[value='en']")) return;

                const enBlock = document.createElement("div");
                enBlock.classList.add("border", "p-3", "rounded", "mb-3", "bg-light", "position-relative", "lang-block");
                enBlock.innerHTML = `
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close"></button>
                    <h5 class="mb-3">English (en)</h5>
                    <input type="hidden" name="translations[0].language" value="en">
                    <div class="mb-3">
                        <label class="form-label">Tiêu đề (en)</label>
                        <input type="text" class="form-control" name="translations[0].title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Câu hỏi (en)</label>
                        <textarea class="form-control" name="translations[0].question" rows="3"></textarea>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Trả lời (en)</label>
                        <textarea class="form-control" name="translations[0].answer" rows="3"></textarea>
                    </div>
                `;
                langContainer.appendChild(enBlock);
                addLangBtn.style.display = "none";

                enBlock.querySelector(".btn-close").addEventListener("click", () => {
                    enBlock.remove();
                    addLangBtn.style.display = "block";
                });
            });
        });
    </script>
</th:block>

</body>
</html>


